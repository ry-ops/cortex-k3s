---
# HorizontalPodAutoscaler for automatic scaling based on metrics
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cortex
  namespace: cortex
  labels:
    app.kubernetes.io/name: cortex
    app.kubernetes.io/instance: cortex
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: cortex-platform
  annotations:
    description: "Autoscales cortex pods based on CPU and memory utilization"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cortex

  # Minimum and maximum number of replicas
  minReplicas: 3
  maxReplicas: 10

  # Scaling behavior configuration
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
      - type: Pods
        value: 1
        periodSeconds: 60
      selectPolicy: Min
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max

  # Metrics to scale on
  metrics:
  # CPU utilization target
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70

  # Memory utilization target
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80

  # Custom metrics (uncomment if using custom metrics)
  # - type: Pods
  #   pods:
  #     metric:
  #       name: cortex_active_workers
  #     target:
  #       type: AverageValue
  #       averageValue: "100"
  #
  # - type: Pods
  #   pods:
  #     metric:
  #       name: cortex_request_rate
  #     target:
  #       type: AverageValue
  #       averageValue: "1000"

---
# VerticalPodAutoscaler (optional - for right-sizing resource requests)
# Requires VPA to be installed in the cluster
# Uncomment to enable VPA recommendations
#
# apiVersion: autoscaling.k8s.io/v1
# kind: VerticalPodAutoscaler
# metadata:
#   name: cortex
#   namespace: cortex
#   labels:
#     app.kubernetes.io/name: cortex
#     app.kubernetes.io/instance: cortex
#     app.kubernetes.io/component: autoscaling
# spec:
#   targetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: cortex
#   updatePolicy:
#     updateMode: "Off"  # Options: Off, Initial, Recreate, Auto
#   resourcePolicy:
#     containerPolicies:
#     - containerName: cortex
#       minAllowed:
#         cpu: 500m
#         memory: 1Gi
#       maxAllowed:
#         cpu: 4000m
#         memory: 8Gi
#       controlledResources:
#       - cpu
#       - memory
