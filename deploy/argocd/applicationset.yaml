apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cortex-mcp-servers
  namespace: argocd
  labels:
    app.kubernetes.io/name: cortex-mcp-applicationset
    app.kubernetes.io/instance: cortex
    app.kubernetes.io/component: mcp-servers
  annotations:
    argocd.argoproj.io/sync-wave: "2"

spec:
  # Generator configuration
  generators:
    # List generator for MCP server packages
    - list:
        elements:
          - name: mcp-k8s-orchestrator
            namespace: cortex-mcp
            port: 3000
            replicas: 3
            cpu_request: 200m
            cpu_limit: 1000m
            memory_request: 256Mi
            memory_limit: 1Gi
            hpa_min: 3
            hpa_max: 20
            priority: high
            rbac_enabled: true
            specialization: kubernetes

          - name: mcp-n8n-workflow
            namespace: cortex-workflows
            port: 3001
            replicas: 2
            cpu_request: 150m
            cpu_limit: 800m
            memory_request: 256Mi
            memory_limit: 768Mi
            hpa_min: 2
            hpa_max: 10
            priority: medium
            rbac_enabled: false
            specialization: workflow-automation

          - name: mcp-talos-node
            namespace: cortex-mcp
            port: 3002
            replicas: 2
            cpu_request: 100m
            cpu_limit: 500m
            memory_request: 128Mi
            memory_limit: 512Mi
            hpa_min: 2
            hpa_max: 8
            priority: high
            rbac_enabled: true
            specialization: node-management

          - name: mcp-s3-storage
            namespace: cortex-storage
            port: 3003
            replicas: 2
            cpu_request: 100m
            cpu_limit: 500m
            memory_request: 128Mi
            memory_limit: 512Mi
            hpa_min: 2
            hpa_max: 10
            priority: medium
            rbac_enabled: false
            specialization: object-storage

          - name: mcp-postgres-data
            namespace: cortex-storage
            port: 3004
            replicas: 2
            cpu_request: 150m
            cpu_limit: 800m
            memory_request: 256Mi
            memory_limit: 1Gi
            hpa_min: 2
            hpa_max: 12
            priority: high
            rbac_enabled: false
            specialization: database

  # Template for Applications
  template:
    metadata:
      name: '{{name}}'
      namespace: argocd
      labels:
        app.kubernetes.io/name: '{{name}}'
        app.kubernetes.io/instance: cortex-mcp
        app.kubernetes.io/component: mcp-server
        app.kubernetes.io/part-of: cortex
        cortex.automation/specialization: '{{specialization}}'
        cortex.automation/priority: '{{priority}}'
      annotations:
        argocd.argoproj.io/sync-wave: "2"
        notifications.argoproj.io/subscribe.on-deployed.slack: cortex-mcp-deployments
        notifications.argoproj.io/subscribe.on-health-degraded.slack: cortex-mcp-alerts

      finalizers:
        - resources-finalizer.argocd.argoproj.io

    spec:
      project: cortex

      # Source configuration
      source:
        repoURL: https://github.com/ryandahlberg/cortex.git
        targetRevision: main
        path: 'packages/{{name}}/k8s'

        helm:
          releaseName: '{{name}}'

          values: |
            # Image configuration
            image:
              repository: ghcr.io/ryandahlberg/cortex/{{name}}
              tag: latest
              pullPolicy: IfNotPresent

            # Replica configuration
            replicaCount: {{replicas}}

            # Resource limits
            resources:
              limits:
                cpu: {{cpu_limit}}
                memory: {{memory_limit}}
              requests:
                cpu: {{cpu_request}}
                memory: {{memory_request}}

            # Horizontal Pod Autoscaler
            autoscaling:
              enabled: true
              minReplicas: {{hpa_min}}
              maxReplicas: {{hpa_max}}
              targetCPUUtilizationPercentage: 80
              targetMemoryUtilizationPercentage: 80
              behavior:
                scaleDown:
                  stabilizationWindowSeconds: 300
                  policies:
                    - type: Percent
                      value: 50
                      periodSeconds: 60
                scaleUp:
                  stabilizationWindowSeconds: 0
                  policies:
                    - type: Percent
                      value: 100
                      periodSeconds: 30
                    - type: Pods
                      value: 4
                      periodSeconds: 30
                  selectPolicy: Max

            # Service configuration
            service:
              type: ClusterIP
              port: {{port}}
              targetPort: {{port}}
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "{{port}}"
                prometheus.io/path: "/metrics"

            # Service Monitor for Prometheus
            serviceMonitor:
              enabled: true
              interval: 30s
              scrapeTimeout: 10s
              labels:
                release: cortex-monitoring

            # Pod Disruption Budget
            podDisruptionBudget:
              enabled: true
              minAvailable: 1

            # Health probes
            livenessProbe:
              httpGet:
                path: /health
                port: {{port}}
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3

            readinessProbe:
              httpGet:
                path: /ready
                port: {{port}}
              initialDelaySeconds: 10
              periodSeconds: 5
              timeoutSeconds: 3
              failureThreshold: 3

            startupProbe:
              httpGet:
                path: /health
                port: {{port}}
              initialDelaySeconds: 0
              periodSeconds: 5
              timeoutSeconds: 3
              failureThreshold: 30

            # Environment variables
            env:
              - name: NODE_ENV
                value: production
              - name: LOG_LEVEL
                value: info
              - name: MCP_SERVER_NAME
                value: '{{name}}'
              - name: MCP_SERVER_PORT
                value: '{{port}}'
              - name: MCP_SPECIALIZATION
                value: '{{specialization}}'

            # Security context
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              fsGroup: 1000
              capabilities:
                drop:
                  - ALL
              readOnlyRootFilesystem: true

            podSecurityContext:
              seccompProfile:
                type: RuntimeDefault

            # Node selection
            nodeSelector:
              workload-type: mcp-servers

            # Tolerations
            tolerations:
              - key: workload-type
                operator: Equal
                value: mcp-servers
                effect: NoSchedule

            # Affinity rules
            affinity:
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 100
                    podAffinityTerm:
                      labelSelector:
                        matchExpressions:
                          - key: app.kubernetes.io/name
                            operator: In
                            values:
                              - '{{name}}'
                      topologyKey: kubernetes.io/hostname

            # RBAC (conditional)
            rbac:
              create: {{rbac_enabled}}
              {{- if eq "{{rbac_enabled}}" "true" }}
              rules:
                {{- if eq "{{name}}" "mcp-k8s-orchestrator" }}
                - apiGroups: [""]
                  resources: ["pods", "services", "configmaps", "secrets"]
                  verbs: ["get", "list", "watch", "create", "update", "delete"]
                - apiGroups: ["apps"]
                  resources: ["deployments", "statefulsets", "daemonsets"]
                  verbs: ["get", "list", "watch", "create", "update", "delete"]
                - apiGroups: ["batch"]
                  resources: ["jobs", "cronjobs"]
                  verbs: ["get", "list", "watch", "create", "update", "delete"]
                {{- else if eq "{{name}}" "mcp-talos-node" }}
                - apiGroups: [""]
                  resources: ["nodes"]
                  verbs: ["get", "list", "watch", "update"]
                - apiGroups: [""]
                  resources: ["pods"]
                  verbs: ["get", "list", "watch"]
                {{- end }}
              {{- end }}

            # Priority class
            priorityClassName: {{priority}}-priority

            # Network Policy
            networkPolicy:
              enabled: true
              policyTypes:
                - Ingress
                - Egress
              ingress:
                - from:
                    - namespaceSelector:
                        matchLabels:
                          app.kubernetes.io/part-of: cortex
                  ports:
                    - protocol: TCP
                      port: {{port}}
              egress:
                - to:
                    - namespaceSelector: {}
                  ports:
                    - protocol: TCP
                      port: 443
                - to:
                    - namespaceSelector:
                        matchLabels:
                          app.kubernetes.io/part-of: cortex

            # Metrics and monitoring
            metrics:
              enabled: true
              serviceMonitor:
                enabled: true

            # Persistence (if needed)
            persistence:
              enabled: false
              storageClass: fast-ssd
              accessMode: ReadWriteOnce
              size: 10Gi

      # Destination
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'

      # Sync policy
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false

        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - PruneLast=true
          - RespectIgnoreDifferences=true
          - ServerSideApply=true
          - ApplyOutOfSyncOnly=true

        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m

      # Ignore differences for HPA-managed replicas
      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas

        - group: autoscaling
          kind: HorizontalPodAutoscaler
          jsonPointers:
            - /spec/metrics

      # Health assessment
      info:
        - name: MCP Server
          value: '{{name}}'
        - name: Specialization
          value: '{{specialization}}'
        - name: Priority
          value: '{{priority}}'
        - name: Port
          value: '{{port}}'

---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cortex-mcp-matrix
  namespace: argocd
  labels:
    app.kubernetes.io/name: cortex-mcp-matrix
    app.kubernetes.io/instance: cortex
  annotations:
    argocd.argoproj.io/sync-wave: "2"

spec:
  # Matrix generator for multi-environment deployments
  generators:
    - matrix:
        generators:
          # Environment generator
          - list:
              elements:
                - env: production
                  cluster: https://kubernetes.default.svc
                  domain: cortex.prod.local

                - env: staging
                  cluster: https://staging.k8s.local
                  domain: cortex.staging.local

          # MCP server generator
          - list:
              elements:
                - name: mcp-k8s-orchestrator
                - name: mcp-n8n-workflow
                - name: mcp-talos-node

  template:
    metadata:
      name: '{{env}}-{{name}}'
      labels:
        environment: '{{env}}'
        app: '{{name}}'

    spec:
      project: cortex

      source:
        repoURL: https://github.com/ryandahlberg/cortex.git
        targetRevision: '{{env}}'
        path: 'packages/{{name}}/k8s'

        helm:
          valueFiles:
            - values.yaml
            - 'values-{{env}}.yaml'

      destination:
        server: '{{cluster}}'
        namespace: cortex-mcp-{{env}}

      syncPolicy:
        automated:
          prune: true
          selfHeal: true

---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cortex-git-directories
  namespace: argocd
  labels:
    app.kubernetes.io/name: cortex-git-directories
    app.kubernetes.io/instance: cortex

spec:
  # Git directory generator - automatically discover new MCP servers
  generators:
    - git:
        repoURL: https://github.com/ryandahlberg/cortex.git
        revision: main
        directories:
          - path: packages/mcp-*

  template:
    metadata:
      name: '{{path.basename}}'
      labels:
        auto-discovered: "true"

    spec:
      project: cortex

      source:
        repoURL: https://github.com/ryandahlberg/cortex.git
        targetRevision: main
        path: '{{path}}/k8s'

      destination:
        server: https://kubernetes.default.svc
        namespace: cortex-auto-discovered

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
