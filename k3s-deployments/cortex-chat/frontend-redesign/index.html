<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e1e">
    <title>Cortex Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Claude.ai inspired colors */
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e3e3e3;
            --text-secondary: #ababab;
            --text-tertiary: #757575;
            --accent-orange: #d97757;
            --accent-blue: #5b8fd9;
            --error-red: #d9695f;
            --success-green: #6fa06f;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --sidebar-width: 280px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Login Screen */
        #login-screen {
            display: none;
            width: 100vw;
            height: 100vh;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        #login-screen.active {
            display: flex;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 40px 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 32px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            text-align: center;
        }

        .login-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .login-input-group {
            width: 100%;
        }

        .login-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .login-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
        }

        .login-input:focus {
            border-color: var(--accent-orange);
            background: rgba(217, 119, 87, 0.05);
        }

        .login-input::placeholder {
            color: var(--text-tertiary);
        }

        .login-error {
            background: rgba(217, 105, 95, 0.1);
            border: 1px solid rgba(217, 105, 95, 0.3);
            color: var(--error-red);
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
            text-align: center;
        }

        .login-error.show {
            display: block;
        }

        .login-btn {
            width: 100%;
            background: var(--accent-orange);
            border: none;
            border-radius: 8px;
            padding: 14px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .login-btn:hover {
            background: #e2856a;
        }

        .login-btn:disabled {
            background: rgba(217, 119, 87, 0.3);
            cursor: not-allowed;
        }

        /* App Container */
        .app-container {
            display: none;
            flex-direction: row;
            height: 100vh;
        }

        .app-container.authenticated {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .new-chat-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 16px 8px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: var(--bg-tertiary);
        }

        .sidebar-section {
            padding: 12px 0;
        }

        .section-label {
            padding: 8px 20px 6px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Conversation Categories */
        .conversations-section {
            border-bottom: 1px solid var(--border-subtle);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            cursor: pointer;
            user-select: none;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.15s;
        }

        .section-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .conversation-list {
            padding: 4px 8px 8px;
            transition: all 0.2s ease-in-out;
            overflow: hidden;
        }

        .conversation-list.collapsed {
            display: none;
        }

        .badge {
            background: rgba(91, 143, 217, 0.3);
            color: var(--text-primary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }


        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .chat-item.active {
            background: rgba(217, 119, 87, 0.12);
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-title {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .delete-chat-btn {
            background: none;
            border: none;
            color: var(--error-red);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-item:hover .delete-chat-btn {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .sidebar-logout-btn {
            width: 100%;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .sidebar-logout-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px 24px 160px;
            display: flex;
            flex-direction: column;
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .empty-state.hidden {
            display: none;
        }

        .logo-container {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-svg {
            width: 50px;
            height: 50px;
            opacity: 0.6;
        }

        .welcome-text {
            font-size: 20px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 400;
        }

        /* Messages */
        .messages-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 75%;
            box-sizing: border-box;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
            font-size: 14px;
            box-sizing: border-box;
            width: 100%;
        }

        .message.assistant .message-bubble {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: var(--accent-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* Error Fix Suggestion - Mobile First: 100% width, vertical stack */
        .fix-suggestion {
            background: rgba(217, 105, 95, 0.08);
            border: 1px solid rgba(217, 105, 95, 0.25);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        @media (min-width: 769px) {
            .fix-suggestion {
                flex-direction: row;
                align-items: center;
            }
        }

        .fix-suggestion-icon {
            color: var(--error-red);
            font-size: 18px;
            flex-shrink: 0;
        }

        .fix-suggestion-content {
            flex: 1;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .fix-suggestion-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--error-red);
            margin-bottom: 4px;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .fix-suggestion-desc {
            font-size: 12px;
            color: var(--text-secondary);
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
        }

        .fix-btn {
            background: var(--accent-orange);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: normal;
            transition: all 0.2s;
            width: 100%;
            box-sizing: border-box;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 769px) {
            .fix-btn {
                width: auto;
                white-space: nowrap;
                flex-shrink: 0;
            }
        }

        .fix-btn:hover {
            background: #e2856a;
        }

        /* Contextual Suggestion Cards - Mobile First: Force 100% width, vertical stack */
        .suggestion-card {
            background: rgba(91, 143, 217, 0.05);
            border: 1px solid rgba(91, 143, 217, 0.15);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            margin-bottom: 12px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .suggestion-header {
            margin-bottom: 0;
            min-width: 0;
        }

        .suggestion-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-blue);
            display: block;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .suggestion-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 0;
            line-height: 1.4;
            display: block;
            overflow-wrap: break-word;
            word-break: break-word;
            width: 100%;
            box-sizing: border-box;
        }

        .suggestion-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        .suggestion-action-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid rgba(91, 143, 217, 0.3);
            border-radius: 5px;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            box-sizing: border-box;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 36px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .suggestion-action-btn:hover {
            background: rgba(91, 143, 217, 0.15);
            border-color: rgba(91, 143, 217, 0.5);
        }

        .suggestion-action-btn.priority-high {
            background: rgba(91, 143, 217, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .suggestion-action-btn.priority-high:hover {
            background: rgba(91, 143, 217, 0.2);
        }

        .suggestion-action-btn.priority-low {
            opacity: 0.7;
            border-color: rgba(91, 143, 217, 0.2);
        }

        .suggestion-action-btn.priority-low:hover {
            opacity: 1;
        }

        /* Tool Indicator */
        .tool-indicator {
            background: rgba(217, 119, 87, 0.08);
            border: 1px solid rgba(217, 119, 87, 0.2);
            color: var(--accent-orange);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .tool-spinner {
            width: 10px;
            height: 10px;
            border: 2px solid var(--accent-orange);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Input Area */
        .input-area {
            position: fixed;
            bottom: 0;
            left: var(--sidebar-width);
            right: 0;
            background: var(--bg-primary);
            padding: 16px 24px;
            border-top: 1px solid var(--border-subtle);
            box-sizing: border-box;
            width: auto;
        }

        .input-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .input-field {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            padding: 4px 0;
            min-width: 0;
            box-sizing: border-box;
        }

        .input-field::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #6a9ee0;
        }

        .send-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
        }

        /* Thinking Indicator */
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 12px 0;
        }

        .thinking-indicator .dot {
            width: 6px;
            height: 6px;
            background-color: var(--accent-orange);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .thinking-indicator .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .thinking-indicator .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Sidebar Close Button */
        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 20px;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2001;
            transition: all 0.2s;
        }

        .sidebar-close-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .sidebar-close-btn:focus {
            outline: 2px solid var(--accent-orange);
            outline-offset: 2px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 280px;
                z-index: 2000;
                transition: left 0.3s ease-in-out;
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-close-btn {
                display: flex;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 1999;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
            }

            .sidebar-overlay.show {
                opacity: 1;
                pointer-events: all;
            }

            .input-area {
                left: 0;
                right: 0;
                padding: 12px;
                box-sizing: border-box;
            }

            .input-container {
                max-width: 100%;
                box-sizing: border-box;
            }

            .hamburger-btn {
                position: fixed;
                top: env(safe-area-inset-top, 12px);
                left: 12px;
                background: var(--bg-secondary);
                border: 1px solid var(--accent-orange);
                color: var(--accent-orange);
                font-size: 24px;
                width: 44px;
                height: 44px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                transition: all 0.2s;
            }

            .hamburger-btn:focus {
                outline: 2px solid var(--accent-orange);
                outline-offset: 2px;
            }

            .hamburger-btn:hover {
                background: var(--bg-tertiary);
            }

            .chat-messages {
                padding: 80px 12px 160px;
                box-sizing: border-box;
            }

            .message {
                max-width: 100%;
                box-sizing: border-box;
            }

            .message-bubble {
                width: 100%;
                box-sizing: border-box;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            /* Force all cards to 100% width on mobile */
            .suggestion-card,
            .fix-suggestion {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                padding: 12px !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .suggestion-action-btn,
            .fix-btn {
                width: 100% !important;
                box-sizing: border-box !important;
                min-height: 40px;
                white-space: normal !important;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            .tool-indicator {
                display: inline-flex;
                max-width: 100%;
                box-sizing: border-box;
                flex-wrap: wrap;
            }

            /* Ensure tables are scrollable on mobile */
            table {
                max-width: 100% !important;
                overflow-x: auto !important;
                display: block !important;
            }

            code {
                word-break: break-all;
                overflow-wrap: break-word;
            }

            pre {
                overflow-x: auto;
                max-width: 100%;
                box-sizing: border-box;
            }

            pre code {
                display: block;
                width: 100%;
                box-sizing: border-box;
            }
        }

        @media (min-width: 769px) {
            .hamburger-btn {
                display: none;
            }

            .sidebar-overlay {
                display: none;
            }

            .sidebar-close-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="active">
        <div class="login-container">
            <svg class="login-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="loginGrad">
                        <stop offset="0%" style="stop-color:#d97757" />
                        <stop offset="100%" style="stop-color:#c96646" />
                    </radialGradient>
                </defs>
                <circle cx="50" cy="50" r="8" fill="url(#loginGrad)"/>
                <g transform="translate(50,50)">
                    <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(0)"/>
                    <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(45)"/>
                    <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(90)"/>
                    <ellipse rx="3" ry="18" fill="url(#loginGrad)" transform="rotate(135)"/>
                </g>
            </svg>
            <div>
                <h1 class="login-title">Cortex Chat</h1>
                <p class="login-subtitle">Sign in to continue</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="login-error" id="loginError">Invalid credentials</div>
                <div class="login-input-group">
                    <label class="login-label">Username</label>
                    <input type="text" id="username" class="login-input" placeholder="Enter username" autocomplete="username" required>
                </div>
                <div class="login-input-group">
                    <label class="login-label">Password</label>
                    <input type="password" id="password" class="login-input" placeholder="Enter password" autocomplete="current-password" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="app-container">
        <!-- Mobile Menu Button -->
        <button class="hamburger-btn" id="hamburgerBtn" aria-label="Open navigation menu" aria-expanded="false" aria-controls="sidebar">☰</button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation" aria-hidden="true">
            <!-- Close Button for Mobile -->
            <button class="sidebar-close-btn" id="sidebarCloseBtn" aria-label="Close navigation menu">×</button>

            <div class="sidebar-header">
                <h1>Cortex</h1>
            </div>

            <button class="new-chat-btn" id="newChatBtn">
                <span>+</span>
                <span>New chat</span>
            </button>

            <div class="sidebar-section" style="flex: 1; overflow-y: auto;">
                <div class="conversations-section">
                    <div class="section-header" onclick="toggleSection('active')">
                        <span>ACTIVE CHATS</span>
                    </div>
                    <div id="active-conversations" class="conversation-list">
                        <div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No active chats</div>
                    </div>
                </div>

                <div class="conversations-section">
                    <div class="section-header" onclick="toggleSection('in-progress')">
                        <span>IN PROGRESS</span>
                        <span class="badge" id="in-progress-count" style="display: none;">0</span>
                    </div>
                    <div id="in-progress-conversations" class="conversation-list collapsed">
                        <div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No chats in progress</div>
                    </div>
                </div>

                <div class="conversations-section">
                    <div class="section-header" onclick="toggleSection('completed')">
                        <span>COMPLETED</span>
                        <span class="badge" id="completed-count" style="display: none;">0</span>
                    </div>
                    <div id="completed-conversations" class="conversation-list collapsed">
                        <div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">No completed chats</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="sidebar-logout-btn" id="sidebarLogoutBtn">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="chat-messages" id="chatMessages">
                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <div class="logo-container">
                        <svg class="logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="8" fill="#d97757"/>
                            <g transform="translate(50,50)">
                                <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(0)"/>
                                <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(45)"/>
                                <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(90)"/>
                                <ellipse rx="3" ry="18" fill="#d97757" transform="rotate(135)"/>
                            </g>
                        </svg>
                    </div>
                    <div class="welcome-text" id="welcomeText">How can I help you today?</div>
                </div>

                <!-- Messages Container -->
                <div class="messages-container" id="messagesContainer" style="display: none;">
                    <!-- Messages will be appended here -->
                </div>

                <!-- Thinking Indicator -->
                <div id="thinking-indicator" class="thinking-indicator" style="display: none;">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <input type="text" class="input-field" id="messageInput" placeholder="Message Cortex" autocomplete="off">
                    <button class="send-btn" id="sendBtn" disabled>→</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        const STORAGE_KEYS = {
            AUTH_TOKEN: 'cortex_auth_token',
            USERNAME: 'cortex_username',
            CURRENT_CONV: 'cortex_current_conversation'
        };

        const WELCOME_MESSAGES = [
            "How can I help you today?",
            "What would you like to know?",
            "Ready to help with your infrastructure",
            "Ask me about your systems"
        ];

        // State
        let currentConversationId = null;
        let isStreaming = false;
        let isAuthenticated = false;
        let detectedErrors = []; // Track errors for auto-fix

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
        const chatList = document.getElementById('chatList');
        const emptyState = document.getElementById('emptyState');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
        const chatMessages = document.getElementById('chatMessages');
        const newChatBtn = document.getElementById('newChatBtn');

        // Focus trap variables
        let lastFocusedElement = null;

        // Initialize
        function init() {
            checkAuthStatus();

            const welcomeText = document.getElementById('welcomeText');
            welcomeText.textContent = WELCOME_MESSAGES[Math.floor(Math.random() * WELCOME_MESSAGES.length)];

            setupEventListeners();
        }

        function checkAuthStatus() {
            const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
            const username = localStorage.getItem(STORAGE_KEYS.USERNAME);

            if (token && username) {
                showChatInterface();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen(message = null) {
            isAuthenticated = false;
            loginScreen.classList.add('active');
            appContainer.classList.remove('authenticated');

            if (message) {
                loginError.textContent = message;
                loginError.classList.add('show');
            }

            setTimeout(() => usernameInput.focus(), 100);
        }

        function showChatInterface() {
            isAuthenticated = true;
            loginScreen.classList.remove('active');
            appContainer.classList.add('authenticated');
            loadConversations();

            const currentConv = localStorage.getItem(STORAGE_KEYS.CURRENT_CONV);
            if (currentConv) {
                currentConversationId = currentConv;
                loadConversation(currentConv);
            }
        }

        function setupEventListeners() {
            // Login
            loginForm.addEventListener('submit', handleLogin);
            usernameInput.addEventListener('input', () => loginError.classList.remove('show'));
            passwordInput.addEventListener('input', () => loginError.classList.remove('show'));

            // Sidebar - Open
            hamburgerBtn?.addEventListener('click', openSidebar);

            // Sidebar - Close
            sidebarCloseBtn?.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            // Keyboard navigation for sidebar
            document.addEventListener('keydown', handleKeyboardNavigation);

            // Input
            messageInput.addEventListener('input', () => {
                sendBtn.disabled = !messageInput.value.trim();
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendBtn.addEventListener('click', sendMessage);
            sidebarLogoutBtn.addEventListener('click', logout);
            newChatBtn.addEventListener('click', startNewChat);
        }

        // Open sidebar with accessibility
        function openSidebar() {
            lastFocusedElement = document.activeElement;
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('show');

            // Update ARIA states
            hamburgerBtn?.setAttribute('aria-expanded', 'true');
            sidebar.setAttribute('aria-hidden', 'false');
            sidebarOverlay.setAttribute('aria-hidden', 'false');

            // Focus on close button for keyboard users
            setTimeout(() => {
                sidebarCloseBtn?.focus();
            }, 100);

            // Trap focus in sidebar
            trapFocus(sidebar);
        }

        // Close sidebar with accessibility
        function closeSidebar() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');

            // Update ARIA states
            hamburgerBtn?.setAttribute('aria-expanded', 'false');
            sidebar.setAttribute('aria-hidden', 'true');
            sidebarOverlay.setAttribute('aria-hidden', 'true');

            // Return focus to hamburger button
            if (lastFocusedElement && window.innerWidth <= 768) {
                lastFocusedElement.focus();
            }
        }

        // Keyboard navigation handler
        function handleKeyboardNavigation(e) {
            // Close sidebar on Escape key
            if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                closeSidebar();
            }

            // Tab key focus trapping when sidebar is open
            if (e.key === 'Tab' && sidebar.classList.contains('open') && window.innerWidth <= 768) {
                trapFocusOnTab(e);
            }
        }

        // Focus trap implementation
        function trapFocus(element) {
            const focusableElements = element.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );

            if (focusableElements.length === 0) return;

            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            // Store for tab key handling
            element._firstFocusable = firstFocusable;
            element._lastFocusable = lastFocusable;
        }

        // Handle Tab key for focus trapping
        function trapFocusOnTab(e) {
            const focusableElements = sidebar.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );

            if (focusableElements.length === 0) return;

            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            // If shift+tab on first element, go to last
            if (e.shiftKey && document.activeElement === firstFocusable) {
                e.preventDefault();
                lastFocusable.focus();
            }
            // If tab on last element, go to first
            else if (!e.shiftKey && document.activeElement === lastFocusable) {
                e.preventDefault();
                firstFocusable.focus();
            }
        }


        async function handleLogin(e) {
            e.preventDefault();

            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                loginError.textContent = 'Please enter username and password';
                loginError.classList.add('show');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Login failed');
                }

                localStorage.setItem(STORAGE_KEYS.AUTH_TOKEN, data.token);
                localStorage.setItem(STORAGE_KEYS.USERNAME, data.username);

                usernameInput.value = '';
                passwordInput.value = '';
                loginError.classList.remove('show');

                showChatInterface();

            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = error.message || 'Login failed. Please try again.';
                loginError.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function logout() {
            localStorage.removeItem(STORAGE_KEYS.AUTH_TOKEN);
            localStorage.removeItem(STORAGE_KEYS.USERNAME);
            currentConversationId = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_CONV);
            closeSidebar();
            showLoginScreen();
        }

        function handleAuthError() {
            localStorage.removeItem(STORAGE_KEYS.AUTH_TOKEN);
            localStorage.removeItem(STORAGE_KEYS.USERNAME);
            showLoginScreen('Session expired. Please sign in again.');
        }

        async function loadConversations() {
            const activeList = document.getElementById('active-conversations');
            const inProgressList = document.getElementById('in-progress-conversations');
            const completedList = document.getElementById('completed-conversations');

            activeList.innerHTML = '<div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">Loading...</div>';

            try {
                const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                const response = await fetch(`${API_BASE}/api/conversations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                if (!response.ok) throw new Error('Failed to load conversations');

                const data = await response.json();

                // Check if backend supports grouped conversations
                if (data.conversations && data.conversations.active !== undefined) {
                    // Backend provides categorized conversations
                    renderConversationList('active', data.conversations.active || []);
                    renderConversationList('in-progress', data.conversations.in_progress || []);
                    renderConversationList('completed', data.conversations.completed || []);

                    // Update badges
                    updateBadge('in-progress-count', data.counts?.in_progress || 0);
                    updateBadge('completed-count', data.counts?.completed || 0);
                } else {
                    // Fallback: Backend sends flat list, categorize on frontend
                    const conversations = data.conversations || [];

                    // For now, put all in active until backend implements status
                    renderConversationList('active', conversations);
                    renderConversationList('in-progress', []);
                    renderConversationList('completed', []);

                    updateBadge('in-progress-count', 0);
                    updateBadge('completed-count', 0);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                activeList.innerHTML = '<div style="padding: 16px; color: var(--error-red); text-align: center; font-size: 12px;">Failed to load</div>';
            }
        }

        function renderConversationList(category, conversations) {
            const listElement = document.getElementById(`${category}-conversations`);
            listElement.innerHTML = '';

            if (conversations.length === 0) {
                const emptyMessages = {
                    'active': 'No active chats',
                    'in-progress': 'No chats in progress',
                    'completed': 'No completed chats'
                };
                listElement.innerHTML = `<div style="padding: 16px; color: var(--text-tertiary); text-align: center; font-size: 12px;">${emptyMessages[category]}</div>`;
                return;
            }

            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                if (conv.sessionId === currentConversationId) {
                    item.classList.add('active');
                }

                const content = document.createElement('div');
                content.className = 'chat-item-content';

                const title = document.createElement('div');
                title.className = 'chat-item-title';
                title.textContent = conv.title || `Chat ${formatTime(conv.createdAt)}`;

                const time = document.createElement('div');
                time.className = 'chat-item-time';
                time.textContent = formatTime(conv.updatedAt);

                content.appendChild(title);
                content.appendChild(time);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-chat-btn';
                deleteBtn.innerHTML = '×';

                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await deleteConversation(conv.sessionId);
                });

                content.addEventListener('click', async () => {
                    currentConversationId = conv.sessionId;
                    localStorage.setItem(STORAGE_KEYS.CURRENT_CONV, conv.sessionId);
                    await loadConversation(conv.sessionId);
                    closeSidebar();
                    await loadConversations();
                });

                item.appendChild(content);
                item.appendChild(deleteBtn);
                listElement.appendChild(item);
            });
        }

        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function toggleSection(sectionId) {
            const list = document.getElementById(`${sectionId}-conversations`);
            if (list) {
                list.classList.toggle('collapsed');
            }
        }

        async function deleteConversation(conversationId) {
            if (!confirm('Delete this chat?')) return;

            try {
                const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                const response = await fetch(`${API_BASE}/api/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                if (!response.ok) throw new Error('Failed to delete conversation');

                if (currentConversationId === conversationId) {
                    currentConversationId = null;
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_CONV);
                    messagesContainer.innerHTML = '';
                    messagesContainer.style.display = 'none';
                    emptyState.classList.remove('hidden');
                }

                await loadConversations();
            } catch (error) {
                console.error('Error deleting conversation:', error);
                alert('Failed to delete conversation');
            }
        }

        function startNewChat() {
            currentConversationId = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_CONV);
            messagesContainer.innerHTML = '';
            messagesContainer.style.display = 'none';
            emptyState.classList.remove('hidden');
            closeSidebar();
            loadConversations();
            messageInput.focus();
            detectedErrors = []; // Clear error tracking
        }

        async function loadConversation(conversationId, forceReload = false) {
            try {
                // CRITICAL: Don't reload if actively streaming unless explicitly forced
                // This prevents race conditions where streaming messages get cleared from DOM
                if (isStreaming && !forceReload) {
                    console.log('[LoadConversation] Skipping reload - streaming in progress');
                    return;
                }

                const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                const response = await fetch(`${API_BASE}/api/conversations/${conversationId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                if (!response.ok) throw new Error('Failed to load conversation');

                const data = await response.json();
                const conv = data.conversation;

                if (!conv) return;

                emptyState.classList.add('hidden');
                messagesContainer.style.display = 'flex';
                messagesContainer.innerHTML = '';

                conv.messages.forEach(msg => {
                    appendMessage(msg.role, msg.content, false);
                });

                scrollToBottom();
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            if (!isAuthenticated) {
                showLoginScreen('Please sign in to continue');
                return;
            }

            messageInput.disabled = true;
            sendBtn.disabled = true;
            isStreaming = true;

            emptyState.classList.add('hidden');
            messagesContainer.style.display = 'flex';

            appendMessage('user', message);
            messageInput.value = '';

            document.getElementById('thinking-indicator').style.display = 'flex';

            if (!currentConversationId) {
                currentConversationId = generateId();
                localStorage.setItem(STORAGE_KEYS.CURRENT_CONV, currentConversationId);
            }

            let history = [];
            try {
                const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                const convResponse = await fetch(`${API_BASE}/api/conversations/${currentConversationId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (convResponse.ok) {
                    const convData = await convResponse.json();
                    history = convData.conversation?.messages || [];
                }
            } catch (e) {
                // No existing conversation
            }

            try {
                const requestBody = {
                    message: message,
                    sessionId: currentConversationId || `session-${Date.now()}`
                };

                if (history.length > 0) {
                    requestBody.history = history;
                }

                const authToken = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.status === 401) {
                    handleAuthError();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';
                let messageDiv = null;
                let toolIndicators = new Map();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6).trim();

                            // Skip [DONE] marker
                            if (dataStr === '[DONE]') continue;

                            try {
                                const data = JSON.parse(dataStr);

                                if (data.type === 'content_block_delta' && data.delta) {
                                    assistantMessage += data.delta;

                                    if (!messageDiv) {
                                        messageDiv = appendMessage('assistant', assistantMessage);
                                    } else {
                                        const bubble = messageDiv.querySelector('.message-bubble');
                                        bubble.innerHTML = formatMarkdown(assistantMessage);
                                    }
                                    scrollToBottom();
                                }
                                else if (data.type === 'tool_execution_error' && data.toolName) {
                                    // Track error for auto-fix
                                    detectedErrors.push({
                                        tool: data.toolName,
                                        error: data.error,
                                        timestamp: Date.now()
                                    });

                                    const toolDiv = toolIndicators.get(data.toolName);
                                    const errorMsg = data.error || 'Unknown error';

                                    if (toolDiv) {
                                        toolDiv.style.borderColor = 'rgba(217, 105, 95, 0.4)';
                                        toolDiv.style.backgroundColor = 'rgba(217, 105, 95, 0.1)';
                                        toolDiv.innerHTML = `<span style="color: var(--error-red);">✗ ${data.toolName}: ${errorMsg}</span>`;
                                    }

                                    // Add fix suggestion
                                    if (!messageDiv) {
                                        messageDiv = document.createElement('div');
                                        messageDiv.className = 'message assistant';
                                        messagesContainer.appendChild(messageDiv);
                                    }

                                    const fixDiv = document.createElement('div');
                                    fixDiv.className = 'fix-suggestion';
                                    fixDiv.innerHTML = `
                                        <div class="fix-suggestion-icon">⚠</div>
                                        <div class="fix-suggestion-content">
                                            <div class="fix-suggestion-title">Issue detected: ${data.toolName}</div>
                                            <div class="fix-suggestion-desc">${errorMsg}</div>
                                        </div>
                                        <button class="fix-btn" onclick="autoFixError('${data.toolName}', '${errorMsg.replace(/'/g, "\\'")}')">Fix it</button>
                                    `;
                                    messageDiv.appendChild(fixDiv);
                                    scrollToBottom();
                                }
                                else if (data.type === 'issues_detected' && data.issues) {
                                    // Handle detected issues - add fix buttons
                                    if (!messageDiv) {
                                        messageDiv = document.createElement('div');
                                        messageDiv.className = 'message assistant';
                                        messagesContainer.appendChild(messageDiv);
                                    }

                                    // Add fix suggestions for each issue
                                    data.issues.forEach(issue => {
                                        const fixDiv = document.createElement('div');
                                        fixDiv.className = 'fix-suggestion';

                                        const fixPrompt = `Fix the issue: ${issue.title}. ${issue.description}`;

                                        fixDiv.innerHTML = `
                                            <div class="fix-suggestion-content" style="flex: 1;">
                                                <div class="fix-suggestion-title">${issue.severity.toUpperCase()}: ${issue.title}</div>
                                                <div class="fix-suggestion-desc">${issue.description}</div>
                                            </div>
                                            ${issue.autoFixable ?
                                                `<button class="fix-btn" onclick="autoFixIssue('${issue.type}', '${issue.resource.name}', '${issue.resource.namespace || ''}')">Fix it</button>` :
                                                `<button class="fix-btn" onclick="investigateIssue('${fixPrompt.replace(/'/g, "\\'")}')">Investigate</button>`
                                            }
                                        `;
                                        messageDiv.appendChild(fixDiv);
                                    });
                                    scrollToBottom();
                                }
                                else if (data.type === 'suggestions' && data.suggestions) {
                                    // Handle contextual suggestions
                                    if (!messageDiv) {
                                        messageDiv = document.createElement('div');
                                        messageDiv.className = 'message assistant';
                                        messagesContainer.appendChild(messageDiv);
                                    }

                                    renderSuggestions(data.suggestions, messageDiv);
                                }
                                else if (data.type === 'youtube_processing') {
                                    // YouTube workflow started - update sidebar but DON'T reload conversation during streaming
                                    // The conversation will auto-reload after streaming completes
                                    setTimeout(async () => {
                                        await loadConversations(); // Update sidebar only
                                        // Don't call loadConversation() here - it will be called after message_stop
                                    }, 3000);
                                }
                                else if (data.type === 'details_posted') {
                                    // Details command processed - but DON'T reload during active streaming
                                    // Protection is in loadConversation() - it will skip if isStreaming=true
                                    await loadConversation(currentConversationId);
                                }
                                else if (data.type === 'message_stop') {
                                    if (assistantMessage) {
                                        await loadConversations();

                                        // Check if response is incomplete/stuck
                                        if (detectIncompleteResponse(assistantMessage)) {
                                            if (!messageDiv) {
                                                messageDiv = document.createElement('div');
                                                messageDiv.className = 'message assistant';
                                                messagesContainer.appendChild(messageDiv);
                                            }

                                            // Add Continue Investigation button
                                            const continueDiv = document.createElement('div');
                                            continueDiv.className = 'fix-suggestion';
                                            continueDiv.style.background = 'rgba(91, 143, 217, 0.08)';
                                            continueDiv.style.borderColor = 'rgba(91, 143, 217, 0.25)';
                                            continueDiv.innerHTML = `
                                                <div class="fix-suggestion-content" style="flex: 1;">
                                                    <div class="fix-suggestion-title">Investigation incomplete</div>
                                                    <div class="fix-suggestion-desc">The response appears to be incomplete. Continue with the investigation?</div>
                                                </div>
                                                <button class="fix-btn" onclick="continueInvestigation()">Continue</button>
                                            `;
                                            messageDiv.appendChild(continueDiv);
                                            scrollToBottom();
                                        }
                                    }
                                }
                                else if (data.type === 'error') {
                                    throw new Error(data.error || 'Unknown error occurred');
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Chat error:', error);

                if (error.message.includes('401') || error.message.includes('unauthorized')) {
                    handleAuthError();
                    return;
                }

                appendMessage('assistant', `Error: ${error.message}`);
            } finally {
                document.getElementById('thinking-indicator').style.display = 'none';
                messageInput.disabled = false;
                sendBtn.disabled = false;
                isStreaming = false;
                messageInput.focus();

                // After streaming completes, reload conversation to ensure sync with backend
                // This catches any async updates that happened during streaming
                setTimeout(async () => {
                    await loadConversation(currentConversationId, true); // Force reload now that streaming is done
                }, 500);
            }
        }

        // Detect if response is incomplete/stuck
        function detectIncompleteResponse(text) {
            const incompletePatterns = [
                /let me try.*$/i,
                /i'll try.*$/i,
                /i will try.*$/i,
                /let me check.*$/i,
                /i'll check.*$/i,
                /let me get.*$/i,
                /i'll get.*$/i,
                /let me.*with a different approach$/i,
                /however,?\s*(i notice|let me|i'll)/i,
                /but based on.*let me/i,
                /failed to.*let me try/i,
                /error.*let me/i,
                /couldn't.*let me/i,
                /unable to.*let me/i
            ];

            const text_trimmed = text.trim();
            return incompletePatterns.some(pattern => pattern.test(text_trimmed));
        }

        // Auto-fix function for tool errors
        window.autoFixError = async function(toolName, errorMsg) {
            const fixPrompt = `The ${toolName} tool encountered an error: "${errorMsg}". Please diagnose and fix this issue.`;
            messageInput.value = fixPrompt;
            await sendMessage();
        };

        // Auto-fix function for detected issues
        window.autoFixIssue = async function(issueType, resourceName, namespace) {
            let fixPrompt = '';

            switch(issueType) {
                case 'pod_stuck':
                    fixPrompt = `Fix the pod "${resourceName}" stuck in ContainerCreating state in namespace "${namespace}". First describe the pod to identify the issue, then take appropriate action.`;
                    break;
                case 'high_restarts':
                    fixPrompt = `Investigate why "${resourceName}" has high restart counts. Check logs and describe the pod to find the root cause.`;
                    break;
                case 'image_pull_error':
                    fixPrompt = `Fix the ImagePullBackOff error for pod "${resourceName}". Check the image name and registry credentials.`;
                    break;
                case 'crash_loop':
                    fixPrompt = `Diagnose and fix the CrashLoopBackOff for pod "${resourceName}". Review logs for errors.`;
                    break;
                case 'pending_pvc':
                    fixPrompt = `Resolve the pending PersistentVolumeClaim "${resourceName}". Check storage classes and available PVs.`;
                    break;
                case 'node_pressure':
                    fixPrompt = `Address node pressure on "${resourceName}". Check node resources and suggest fixes.`;
                    break;
                default:
                    fixPrompt = `Fix the issue with ${resourceName}.`;
            }

            messageInput.value = fixPrompt;
            await sendMessage();
        };

        // Investigate function for non-auto-fixable issues
        window.investigateIssue = async function(prompt) {
            messageInput.value = prompt;
            await sendMessage();
        };

        // Continue investigation function
        window.continueInvestigation = async function() {
            const continuePrompt = "Continue investigating. If the previous approach didn't work, try an alternative method to accomplish the task.";
            messageInput.value = continuePrompt;
            await sendMessage();
        };

        // Execute suggestion function
        window.executeSuggestion = async function(prompt) {
            messageInput.value = prompt;
            await sendMessage();
        };

        // Render contextual suggestion cards
        function renderSuggestions(suggestions, messageDiv) {
            if (!suggestions || suggestions.length === 0) return;

            suggestions.forEach(suggestion => {
                const suggestionCard = document.createElement('div');
                suggestionCard.className = 'suggestion-card';

                // Build action buttons
                let actionsHTML = '';
                if (suggestion.actions && suggestion.actions.length > 0) {
                    actionsHTML = '<div class="suggestion-actions">';
                    suggestion.actions.forEach((action, idx) => {
                        const priorityClass = action.priority === 'high' ? 'priority-high' :
                                            action.priority === 'low' ? 'priority-low' : '';
                        const buttonId = `suggestion-btn-${Date.now()}-${idx}`;
                        actionsHTML += `<button class="suggestion-action-btn ${priorityClass}" id="${buttonId}">${action.label}</button>`;

                        // Add event listener after rendering
                        setTimeout(() => {
                            const btn = document.getElementById(buttonId);
                            if (btn) {
                                btn.onclick = async () => {
                                    messageInput.value = action.prompt;
                                    await sendMessage();
                                };
                            }
                        }, 0);
                    });
                    actionsHTML += '</div>';
                }

                suggestionCard.innerHTML = `
                    <div class="suggestion-header">
                        <span class="suggestion-title">${suggestion.title}</span>
                    </div>
                    <div class="suggestion-description">${suggestion.description}</div>
                    ${actionsHTML}
                `;

                messageDiv.appendChild(suggestionCard);
            });

            scrollToBottom();
        }

        function appendMessage(role, content, save = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = formatMarkdown(content);

            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);

            scrollToBottom();
            return messageDiv;
        }

        function formatMarkdown(text) {
            let formatted = text;

            // Code blocks (must be before inline code)
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code>${code.trim()}</code></pre>`;
            });

            // Markdown tables
            formatted = formatted.replace(/(\|[^\n]+\|\n\|[-:\| ]+\|\n(?:\|[^\n]+\|\n?)+)/g, (match) => {
                const lines = match.trim().split('\n');
                if (lines.length < 3) return match;

                const headers = lines[0].split('|').map(h => h.trim()).filter(h => h);
                const rows = lines.slice(2).map(row =>
                    row.split('|').map(cell => cell.trim()).filter(cell => cell)
                );

                let table = '<table style="border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 13px;">';
                table += '<thead><tr>';
                headers.forEach(header => {
                    table += `<th style="border: 1px solid var(--border-color); padding: 8px; background: var(--bg-secondary); text-align: left;">${header}</th>`;
                });
                table += '</tr></thead><tbody>';
                rows.forEach(row => {
                    table += '<tr>';
                    row.forEach(cell => {
                        table += `<td style="border: 1px solid var(--border-color); padding: 8px;">${cell}</td>`;
                    });
                    table += '</tr>';
                });
                table += '</tbody></table>';
                return table;
            });

            // Inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Headers
            formatted = formatted.replace(/^### (.+)$/gm, '<p style="font-weight: 600; margin-top: 12px; margin-bottom: 6px;">$1</p>');
            formatted = formatted.replace(/^## (.+)$/gm, '<p style="font-weight: 600; font-size: 1.1em; margin-top: 14px; margin-bottom: 8px;">$1</p>');
            formatted = formatted.replace(/^# (.+)$/gm, '<p style="font-weight: 700; font-size: 1.15em; margin-top: 16px; margin-bottom: 10px;">$1</p>');

            // Lists
            formatted = formatted.replace(/^- (.+)$/gm, '<div style="margin-left: 14px; margin-bottom: 4px;">• $1</div>');
            formatted = formatted.replace(/^\* (.+)$/gm, '<div style="margin-left: 14px; margin-bottom: 4px;">• $1</div>');
            formatted = formatted.replace(/^(\d+)\. (.+)$/gm, '<div style="margin-left: 14px; margin-bottom: 4px;">$1. $2</div>');

            // Bold and italic
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Paragraphs
            formatted = formatted.replace(/\n\n/g, '</p><p style="margin-top: 8px; margin-bottom: 8px;">');
            formatted = '<p style="margin-top: 8px; margin-bottom: 8px;">' + formatted + '</p>';
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function generateId() {
            return `conv_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString();
        }


        // Initialize
        init();
    </script>
</body>
</html>
