{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Routing Decision Event",
  "description": "Schema for tracking routing decisions through the 5-layer cascade",
  "type": "object",
  "required": [
    "event_id",
    "timestamp",
    "task_description",
    "routing_layers",
    "final_decision",
    "total_latency_ms"
  ],
  "properties": {
    "event_id": {
      "type": "string",
      "description": "Unique identifier for this routing decision",
      "pattern": "^route-[0-9]{8}-[0-9]{6}-[a-f0-9]{8}$"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of routing decision"
    },
    "task_id": {
      "type": "string",
      "description": "Associated task ID if available"
    },
    "task_description": {
      "type": "string",
      "description": "Natural language task description"
    },
    "task_metadata": {
      "type": "object",
      "description": "Additional task context",
      "properties": {
        "priority": {"type": "string", "enum": ["low", "medium", "high", "critical"]},
        "source": {"type": "string"},
        "user_id": {"type": "string"}
      }
    },
    "routing_layers": {
      "type": "array",
      "description": "Cascade of routing attempts through each layer",
      "items": {
        "type": "object",
        "required": ["layer_id", "layer_name", "attempted", "confidence"],
        "properties": {
          "layer_id": {"type": "integer", "minimum": 1, "maximum": 5},
          "layer_name": {"type": "string", "enum": ["keyword", "semantic", "rag", "pytorch", "clarification"]},
          "attempted": {"type": "boolean"},
          "success": {"type": "boolean"},
          "confidence": {"type": "number", "minimum": 0, "maximum": 1},
          "threshold": {"type": "number", "minimum": 0, "maximum": 1},
          "selected_master": {"type": ["string", "null"]},
          "latency_ms": {"type": "number", "minimum": 0},
          "metadata": {
            "type": "object",
            "description": "Layer-specific metadata"
          }
        }
      }
    },
    "final_decision": {
      "type": "object",
      "required": ["selected_master", "routing_layer", "confidence"],
      "properties": {
        "selected_master": {
          "type": "string",
          "enum": ["development-master", "security-master", "inventory-master", "cicd-master", "coordinator-master"]
        },
        "routing_layer": {
          "type": "string",
          "enum": ["keyword", "semantic", "rag", "pytorch", "clarification"]
        },
        "confidence": {"type": "number", "minimum": 0, "maximum": 1},
        "all_probabilities": {
          "type": "object",
          "description": "Probability distribution across all masters"
        }
      }
    },
    "total_latency_ms": {
      "type": "number",
      "minimum": 0,
      "description": "Total time for routing decision across all attempted layers"
    },
    "outcome": {
      "type": "object",
      "description": "Task outcome for learning",
      "properties": {
        "task_completed": {"type": "boolean"},
        "task_status": {"type": "string", "enum": ["completed", "failed", "in_progress", "unknown"]},
        "was_correct_master": {"type": ["boolean", "null"]},
        "user_corrected_to": {"type": ["string", "null"]},
        "completion_time_minutes": {"type": ["number", "null"]},
        "quality_score": {"type": ["number", "null"], "minimum": 0, "maximum": 1}
      }
    },
    "learning_feedback": {
      "type": "object",
      "description": "Feedback for model training and threshold tuning",
      "properties": {
        "correct_routing": {"type": "boolean"},
        "should_have_routed_to": {"type": ["string", "null"]},
        "layer_should_have_caught": {"type": ["string", "null"]},
        "threshold_too_high": {"type": "boolean"},
        "threshold_too_low": {"type": "boolean"}
      }
    }
  }
}
