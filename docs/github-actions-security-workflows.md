# GitHub Actions Security Scanning Workflows

Automated CVE scanning infrastructure deployed across all ry-ops repositories.

## Overview

Comprehensive security scanning workflows have been deployed to three repositories:
- **cortex** (NPM + Python)
- **blog** (NPM only)
- **DriveIQ** (NPM + Python)

## Workflow Files Created

### 1. Cortex Repository
**Location**: `/Users/ryandahlberg/Projects/cortex/.github/workflows/security-scan.yml`

**Ecosystems Scanned**:
- NPM (package.json)
- Python (python-sdk/requirements.txt, evaluation/requirements.txt)

**Jobs**:
1. `npm-audit` - NPM vulnerability scanning
2. `python-audit` - Python security audit (matrix strategy for multiple requirements files)
3. `trivy-scan` - Comprehensive filesystem vulnerability scanning
4. `sbom-generation` - Software Bill of Materials generation + Grype scanning
5. `security-summary` - Aggregated security report

### 2. Blog Repository
**Location**: `/Users/ryandahlberg/Projects/blog/.github/workflows/security-scan.yml`

**Ecosystems Scanned**:
- NPM (Astro + dependencies)

**Jobs**:
1. `npm-audit` - NPM vulnerability scanning
2. `trivy-scan` - Filesystem vulnerability scanning
3. `sbom-generation` - SBOM generation + Grype scanning
4. `security-summary` - Aggregated security report

### 3. DriveIQ Repository
**Location**: `/Users/ryandahlberg/Projects/DriveIQ/.github/workflows/security-scan.yml`

**Ecosystems Scanned**:
- NPM (React frontend)
- Python (FastAPI backend)

**Jobs**:
1. `npm-audit-frontend` - NPM vulnerability scanning for frontend
2. `python-audit-backend` - Python security audit for backend
3. `trivy-scan` - Comprehensive filesystem scanning
4. `sbom-generation` - Dual SBOM generation (frontend + backend) + Grype scanning
5. `security-summary` - Aggregated security report

## Trigger Configuration

All workflows are configured to run on:

### 1. Push Events
```yaml
on:
  push:
    branches: [ main ]
```
Every push to main branch triggers a security scan.

### 2. Pull Request Events
```yaml
on:
  pull_request:
    branches: [ main ]
```
PRs targeting main are scanned before merge.

### 3. Scheduled Daily Scans
```yaml
on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
```
Automated daily scans at 2 AM UTC to catch new CVEs.

## Security Tools Integrated

### 1. NPM Audit
- **Purpose**: Scan npm dependencies for known vulnerabilities
- **Threshold**: Fails on HIGH or CRITICAL vulnerabilities
- **Output**: JSON results uploaded as artifacts

### 2. pip-audit
- **Purpose**: Python dependency vulnerability scanning
- **Service**: OSV (Open Source Vulnerabilities)
- **Threshold**: Fails on vulnerabilities
- **Output**: JSON results uploaded as artifacts

### 3. Trivy
- **Purpose**: Multi-ecosystem filesystem vulnerability scanner
- **Formats**: SARIF (for GitHub Security) + JSON
- **Severity**: CRITICAL, HIGH, MEDIUM
- **Features**:
  - Automatic upload to GitHub Security tab
  - Fails build on CRITICAL or HIGH vulnerabilities
  - Comprehensive ecosystem support

### 4. Syft
- **Purpose**: Software Bill of Materials (SBOM) generation
- **Formats**:
  - SPDX-JSON (industry standard)
  - CycloneDX-JSON (OWASP standard)
- **Retention**: 90 days
- **Features**:
  - Full dependency tree capture
  - License information
  - Package metadata

### 5. Grype
- **Purpose**: Vulnerability scanning from SBOM
- **Input**: SBOM files generated by Syft
- **Threshold**: Fails on HIGH vulnerabilities
- **Output**: JSON results with detailed CVE information

## Artifact Retention

| Artifact Type | Retention Period |
|---------------|------------------|
| npm-audit results | 30 days |
| pip-audit results | 30 days |
| Trivy scan results | 30 days |
| SBOM files (SPDX + CycloneDX) | 90 days |
| Grype scan results | 30 days |

## Failure Conditions

Workflows will FAIL if:

1. **Critical or High NPM vulnerabilities** detected
   ```bash
   npm audit --audit-level=high
   ```

2. **Any Python vulnerabilities** detected
   ```bash
   pip-audit --vulnerability-service osv
   ```

3. **Critical or High Trivy vulnerabilities** found
   ```bash
   if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
     exit 1
   fi
   ```

4. **High Grype vulnerabilities** in SBOM
   ```bash
   grype sbom:sbom-spdx.json --fail-on high
   ```

## GitHub Security Integration

### SARIF Upload
All Trivy scans upload SARIF format to GitHub Security tab:
```yaml
- name: Upload Trivy results to GitHub Security
  uses: github/codeql-action/upload-sarif@v3
  with:
    sarif_file: 'trivy-results.sarif'
```

**Benefits**:
- Vulnerabilities visible in GitHub Security tab
- Integration with Dependabot alerts
- Security Advisory notifications
- Vulnerability remediation suggestions

## Security Summary Reports

Each workflow generates a comprehensive security summary:

```markdown
# Security Scan Summary

Scan Date: 2025-11-30 21:49:00 UTC

## Scan Results

### NPM Audit
{
  "info": 0,
  "low": 0,
  "moderate": 0,
  "high": 0,
  "critical": 0
}

### Trivy Scan
- Critical: 0
- High: 0
- Medium: 0

## Artifacts Generated
- NPM Audit Results
- Trivy Scan Results (SARIF + JSON)
- SBOM (SPDX + CycloneDX)
- Grype Scan Results
```

## Status Badges

Security scan status badges added to all README files:

### Cortex
```markdown
[![Security Scan](https://github.com/ry-ops/cortex/actions/workflows/security-scan.yml/badge.svg)](https://github.com/ry-ops/cortex/actions/workflows/security-scan.yml)
```

### Blog
```markdown
[![Security Scan](https://github.com/ry-ops/blog/actions/workflows/security-scan.yml/badge.svg)](https://github.com/ry-ops/blog/actions/workflows/security-scan.yml)
```

### DriveIQ
```markdown
[![Security Scan](https://github.com/ry-ops/DriveIQ/actions/workflows/security-scan.yml/badge.svg)](https://github.com/ry-ops/DriveIQ/actions/workflows/security-scan.yml)
```

## Permissions Required

```yaml
permissions:
  contents: read           # Read repository code
  security-events: write   # Upload SARIF to Security tab
  pull-requests: write     # Comment on PRs (optional)
```

## Repository-Specific Features

### Cortex (Multi-Python)
- Matrix strategy for multiple Python requirements files
- Separate scans for python-sdk and evaluation modules
- Comprehensive npm + python coverage

### Blog (Static Site)
- Focused npm scanning for Astro framework
- Lightweight workflow optimized for static sites
- Node.js 20 runtime

### DriveIQ (Full-Stack)
- Dual SBOM generation (frontend + backend)
- Separate npm and python audit jobs
- Working directory isolation for frontend/backend
- Independent Grype scans for each stack

## Testing Workflow

To test the workflows locally before pushing:

```bash
# Install act (GitHub Actions local runner)
brew install act

# Run security scan workflow
cd /Users/ryandahlberg/Projects/cortex
act -j npm-audit

# Run with specific event
act pull_request

# Run scheduled event
act schedule
```

## Monitoring & Alerts

### GitHub Notifications
- Workflow failure emails sent to repository owners
- Security Advisory notifications
- Dependabot alerts for vulnerable dependencies

### Action Status
- View workflow runs: `https://github.com/ry-ops/{repo}/actions`
- Security tab: `https://github.com/ry-ops/{repo}/security`
- Dependency graph: `https://github.com/ry-ops/{repo}/network/dependencies`

## Integration with Cortex Security Master

These workflows integrate with the existing Cortex security infrastructure:

1. **Local Scans**: Cortex Security Master runs Trivy/Grype locally
2. **CI Scans**: GitHub Actions runs on every push/PR/daily
3. **Reporting**: Both systems feed into portfolio health dashboard
4. **Remediation**: Findings from both sources trigger security-fix workers

## Next Steps

1. **Push workflows to GitHub**:
   ```bash
   cd /Users/ryandahlberg/Projects/cortex
   git add .github/workflows/security-scan.yml README.md
   git commit -m "feat: Add automated CVE scanning workflow"
   git push origin main
   ```

2. **Verify first run**:
   - Watch workflow execute
   - Check artifacts generated
   - Verify SARIF upload to Security tab

3. **Configure notifications**:
   - GitHub > Settings > Notifications
   - Enable workflow failure alerts
   - Enable security advisory emails

4. **Monitor portfolio**:
   ```bash
   # View all workflow statuses
   ./scripts/run-security-master.sh --check-ci-status
   ```

## Success Metrics

Target KPIs for security scanning:

- **Scan Coverage**: 100% of repositories (3/3 achieved)
- **Scan Frequency**: Daily minimum (configured)
- **Response Time**: PR scans complete in < 5 minutes
- **Vulnerability Detection**: Zero CRITICAL/HIGH in production
- **SBOM Generation**: 100% coverage (achieved)
- **Artifact Retention**: 30-90 days (configured)

## Maintenance

### Weekly Tasks
- Review security scan summaries
- Triage new vulnerabilities
- Update dependencies with fixes

### Monthly Tasks
- Review SBOM artifacts
- Audit scan coverage
- Update scanning tools (Trivy, Grype, Syft)

### Quarterly Tasks
- Evaluate new security scanning tools
- Review and optimize workflow performance
- Update security policies based on findings

## Support

For issues or questions:
- **Workflow failures**: Check Actions tab in GitHub
- **False positives**: Review Trivy/Grype configurations
- **Integration issues**: Contact Security Master team

---

**Created**: 2025-11-30
**Last Updated**: 2025-11-30
**Status**: Production Ready
**Coverage**: 3/3 repositories (100%)
